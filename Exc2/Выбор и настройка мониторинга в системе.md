# Мотивация

Внедрение мониторинга в существующую инфрастуктуру в совокупности с логированием позволит быстрее идентифицировать причины наблюдаемых проблем в системе. Появится динамика развития показателей и возможность их наглядной визуализации.

Кроме того, мониторинг позволяет настроить нотификацию о "надвигающейся буре" (о том, что пошли отказы в подсистеме или стали появляться аномалии в ее работе), а значит позволит работать на опережение, например, позволяя заблаговременно принять решение о поднятии дополнительных инстансов подсистем или увеличении мощности и количества серверов, т.е. не доводя систему до ее полного отказа.

Организация могла бы задуматься о внедрении бизнес-метрик, интересных для отслеживания, таких как DAU или время нахождения заказа в разных частях подсистемы, например, для оценки KPI отдела продаж или производственной линии.

# Выбор подхода к мониторингу

1. Для API онлайн-магазина, CRM и MES будет использоваться метод четырех золотых сигналов от Google:

- Величина задержек (latency).
- Трафик: количество запросов в секунду (RPS).
- Количество ошибок с кодом 500.
- Насыщенность: использование CPU, памяти.

Для всех метрик кроме "насыщенности" используем path-запроса из заголовка в качестве ярлыка.

2. Для баз данных будут отслеживаться:

- Использование: загрузка CPU и памяти процессом БД, размер хранилища.
- Скорости записи и чтения.
- Насыщенность: количество одновременных подключений к БД (обычно PostgreSQL лимитирует количество соединений, по умолчанию не больше 100)

3. Для брокера сообщений RabbitMQ:
 
- Насыщенность: длина очереди событий.
- Ошибки: показатель "dead-letter-exchange".

Для метрик используем имя топика в качестве ярлыка.

4. Для S3-хранилища важно отслеживать:

- Размер хранилища.
- Скорости записи и чтения.

# План действий

1. Добавить в систему инстанс Prometheus, для сбора и хранения метрик системы.

2. Добавить в систему экспортеры для сбора общесистемных метрик.

3. Настроить Prometheus на сбор общесистемных метрик.

4. Включить публикацию метрик для баз-данных, S3-хранилища и RabbitMQ.

5. Настроить Prometheus на сбор метрик с хранилищ и брокера сообщений.

6. Реализовать расчет метрик и их публикацию по HTTP в существующих системах (онлайн-магазин, CRM, MES).

7. Настроить Prometheus на сбор метрик с API подсистем.

8. Добавить в систему инстанс Grafana и настроить дашборы для наглядной визуализации метрик.

9. Настроить алерты с правилами нотификации в Prometheus.