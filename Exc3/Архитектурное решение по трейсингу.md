# Анализ

Так как трейсинг начинается с точки входа в приложение, а таких приложений в системе 3, то желательно покрыть трейсингом Shop API, CRM API и MES API.

Помимо стандартных атрибутов TraceId и SpanId, а также места и контекста операции необходимо добавить информацию об уникальном идентификаторе заказа. Будет полезной информация о смене статуса заказа (если она происходит в рамках вызова).

# Мотивация

Внедрение трейсинга сделает возможным разбор непонятных ситуаций с потерей заказов в системе без обкладывания кода сервисов большим количеством логов (что может оказаться еще и дорогим решением, т.к. большой объем информации нужно будет где-то хранить, а хранилище стоит денег).

Кроме получения наглядности в том, в какой последовательности запросы приходили и проходили по системе, появится возможность локализовать неоптимальные места, где запросы обрабатываются долго или возникают задержки. Это поможет эффективнее диагностировать и устранять проблемы с производительностью.

Резюмируем:
- увеличение вероятности успеха в разборе инцидентов
- экономия средств компании на дорогостоящих хранилищах в облаке
- появление дополнительного инструмента диагностики проблем с производительностью

# Предлагаемое решение

Трейсинг будет реализован с использованием OpenTelemetry. 

Потребуется:

- доработка трех сервисов: подключение соответствующих SDK для Java для Shop API и CRM API (Java, Spring Boot) и SDK для C# для MES API, переписывание кода сервисов с формированием контекста с информацией по заказу и изменению статуса.
- организация хранилища трейсов, будет использоваться Jaeger напрямую.

[Доработанная диаграмма C4](./jewerly_c4_model.drawio)

# Компромиссы

Могут возникнуть сложности с прикручиванием трейсинга в приобретенную систему MES, написанную на C#. Разработчик на C# один (не считая тимлида), начитанность в коде MES скорее всего небольшая.

# Аспекты безопасности

- Внедрение защищенного канала экспорта трейсов - настройка TLS в Jaeger.
- С настройками TLS или авторизации у Jaeger-UI пока все плохо. Но можно спрятать UI за API-gateway, например, APISIX, настроив аутентификацию на имеющийся в системе сервис.